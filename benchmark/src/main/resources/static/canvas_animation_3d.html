<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>

	<title>Benchmark - Canvas + Shadow</title>

	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta name="author" content="The Man in Blue" />
	<meta name="robots" content="all" />
	<meta name="MSSmartTagsPreventParsing" content="true" />
	<meta name="description" content="" />
	<meta name="keywords" content="" />

	<style type="text/css">
	
	html
	{
		height: 100%;
	}
	
	body
	{
		width: 100%;
		height: 100%;
		overflow: hidden;
		margin: 0;
		padding: 0;
	}
	
	span
	{
		position: absolute;
		width: 12px;
		height: 12px;
		overflow: hidden;
		-webkit-border-radius: 6px;
		-moz-border-radius: 6px;
		background-color: #000000;
	}
	
	.shadows span
	{
		-webkit-box-shadow: 4px 4px 3px rgba(0,0,0,0.33);
		-moz-box-shadow: 4px 4px 3px rgba(0,0,0,0.33);
	}
	
	#frameRate
	{
		position: absolute;
		right: 10px;
		bottom: 10px;
		z-index: 100;
		font-size: 25px;
		font-family: Arial, Helvetica, sans-serif;
	}
	
	</style>
	
	<script type="text/javascript" src="js/excanvas.compiled.js"></script>
	<script type="text/javascript">

	var SHADOWS = false;
	var MAX_PARTICLES = 50;
	var MAX_VELOCITY = 500;
	var PARTICLE_RADIUS = 48;
	var STAGE_WIDTH = 1024;
	var STAGE_HEIGHT = 768;
	var COLORS = ["#cc0000", "#ffcc00", "#aaff00", "#0099cc", "#194c99", "#661999"];
	var FRAME_TIMES = [];
	var FrameRates = [];
	var Scale = 5;
	var cnt = 0;
	var particles = [];
	var context = null;
	
	
	window.onload = init;
	
	function init()
	{
		var location = window.location.href;
		
		// If shadows are turned on
		if (location.match(/radius=/))
		{
			var radi = location.match(/radius=([^&]+)/)[1];
			radi = parseInt(radi);
			
			console.log(PARTICLE_RADIUS);
			if (!isNaN(radi))
			{
				PARTICLE_RADIUS = radi;
			}
		}
		
		// If shadows are turned on
		if (location.match(/shadows=true/))
		{
			SHADOWS = true;
		}
		
		// If max_particles is specified
		if (location.match(/particles=/))
		{
			var maxParticles = location.match(/particles=([^&]+)/)[1];
			maxParticles = parseInt(maxParticles);
			
			if (!isNaN(maxParticles))
			{
				MAX_PARTICLES = maxParticles;
			}
		}
		
		STAGE_WIDTH = document.body.offsetWidth;
		STAGE_HEIGHT = document.body.offsetHeight;
		
		// Create the canvas
		var benchmark = document.createElement("canvas");
		benchmark.id = "benchmark";
		benchmark.setAttribute("width", STAGE_WIDTH);
		benchmark.setAttribute("height", STAGE_HEIGHT);
		document.body.insertBefore(benchmark, document.body.firstChild);
		
		// Create the particles
		for (var i = 0; i < MAX_PARTICLES; i++)
		{
			particles.push(new Particle());
		}
		
		var benchmark = document.getElementById("benchmark");
	
		if (typeof benchmark.getContext == "undefined")
		{
			// Try using exCanvas for Internet Explorer
			try
			{
				G_vmlCanvasManager.initElement(benchmark);
			}
			catch (error)
			{
				alert("Sorry, your browser doesn't support CANVAS");
				
				return;
			}
		}
		
		context = benchmark.getContext("2d");
		
		// Start the animation
		setInterval(animate, 1);
	}
	
	function animate()
	{
		// Limit the frame time array to the last 30 frames
		if (FRAME_TIMES.length > 30)
		{
			FRAME_TIMES.splice(0, 1);
		}
		
		var currTime = new Date().getTime();
		
		FRAME_TIMES.push(currTime);
		
		// Calculate the framerate based upon the difference between the absolute times of the oldest and newest frames, subdivided by how many frames were drawn inbetween
		var frameRate = document.getElementById("frameRate");
		var frameRateText = 1000 / ((currTime - FRAME_TIMES[0]) / (FRAME_TIMES.length - 1)) + "";
		frameRateText = frameRateText.replace(/(^[^.]+\...).*/, "$1");
		
		FrameRates.push(frameRateText);
		frameRateText += " FPS";
		frameRate.innerHTML = frameRateText;
		
		var timeDelta = currTime - FRAME_TIMES[FRAME_TIMES.length - 2];
		
		if (isNaN(timeDelta))
		{
			timeDelta = 0;
		}
		
		context.clearRect(0, 0, STAGE_WIDTH, STAGE_HEIGHT);
		
		// Draw each particle
		for (var particle in particles)
		{
			particles[particle].draw(timeDelta);
		}
		
		if(FrameRates.length > 300)
		{
			if(cnt == 0)
			{
				var CSV = '';  
				var fileName = "FrameRate_" + MAX_PARTICLES +"_"+ PARTICLE_RADIUS;
				
				FrameRates[0] = fileName;
				
				for(var j in FrameRates)
				{
					CSV += FrameRates[j] + '\r\n';
				}
				
				var url = "data:text/csv;charset=utf-8," + escape(CSV);
				var link = document.createElement("a");
				
				link.href = url;
			    link.style = "visibility:hidden";
			    link.download = fileName + ".csv";
			    
			    document.body.appendChild(link);
			    link.click();
			    document.body.removeChild(link);
				
			}
			cnt++;
		}
	}
	
	function Particle()
	{
		var angle = Math.PI * 2 * Math.random();
		var velocity = MAX_VELOCITY / 8 * 7 * Math.random() + MAX_VELOCITY / 8;
		var x = STAGE_WIDTH / 2 - PARTICLE_RADIUS;
		var y = STAGE_HEIGHT / 2 - PARTICLE_RADIUS;
		var colors = [];
		
		colors.push(COLORS[Math.floor(Math.random() * COLORS.length)]);
		colors.push(COLORS[Math.floor(Math.random() * COLORS.length)]);
		colors.push(COLORS[Math.floor(Math.random() * COLORS.length)]);
		
		function draw(timeDelta)
		{
			// Calculate next position of particle
			var nextX = x + Math.cos(angle) * velocity * (timeDelta / 1000);
			var nextY = y + Math.sin(angle) * velocity * (timeDelta / 1000);
			
			// If particle is going to move off right side of screen
			if (nextX + PARTICLE_RADIUS * 2 > STAGE_WIDTH)
			{
				// If angle is between 3 o'clock and 6 o'clock
				if ((angle >= 0 && angle < Math.PI / 2))
				{
					angle = Math.PI - angle;
				}
				// If angle is between 12 o'clock and 3 o'clock
				else if (angle > Math.PI / 2 * 3)
				{
					angle = angle - (angle - Math.PI / 2 * 3) * 2
				}
			}
			
			// If particle is going to move off left side of screen
			if (nextX < 0)
			{
				// If angle is between 6 o'clock and 9 o'clock
				if ((angle > Math.PI / 2 && angle < Math.PI))
				{
					angle = Math.PI - angle;
				}
				// If angle is between 9 o'clock and 12 o'clock
				else if (angle > Math.PI && angle < Math.PI / 2 * 3)
				{
					angle = angle + (Math.PI / 2 * 3 - angle) * 2
				}
			}
			
			// If particle is going to move off bottom side of screen
			if (nextY + PARTICLE_RADIUS * 2 > STAGE_HEIGHT)
			{
				// If angle is between 3 o'clock and 9 o'clock
				if ((angle > 0 && angle < Math.PI))
				{
					angle = Math.PI * 2 - angle;
				}
			}
			
			// If particle is going to move off top side of screen
			if (nextY < 0)
			{
				// If angle is between 9 o'clock and 3 o'clock
				if ((angle > Math.PI && angle < Math.PI * 2))
				{
					angle = angle - (angle - Math.PI) * 2;
				}
			}
			
			drawCube(x, y, Scale, Scale, Scale, colors);
			
			x = nextX;
			y = nextY;
		}
		
		return {
			draw: draw
		}
	}
	
	// Draw a cube to the specified specs
	function drawCube(x, y, wx, wy, h, colors) {
		context.beginPath();
		context.moveTo(x, y);
		context.lineTo(x - wx, y - wx * 0.5);
		context.lineTo(x - wx, y - h - wx * 0.5);
		context.lineTo(x, y - h * 1);
		context.closePath();
		context.fillStyle = colors[0];
		context.strokeStyle = colors[0];
		context.stroke();
		context.fill();

		context.beginPath();
		context.moveTo(x, y);
		context.lineTo(x + wy, y - wy * 0.5);
		context.lineTo(x + wy, y - h - wy * 0.5);
		context.lineTo(x, y - h * 1);
		context.closePath();
		context.fillStyle = colors[1];
		context.strokeStyle = colors[1];
		context.stroke();
		context.fill();

		context.beginPath();
		context.moveTo(x, y - h);
		context.lineTo(x - wx, y - h - wx * 0.5);
		context.lineTo(x - wx + wy, y - h - (wx * 0.5 + wy * 0.5));
		context.lineTo(x + wy, y - h - wy * 0.5);
		context.closePath();
		context.fillStyle = colors[2];
		context.strokeStyle = colors[2];
		context.stroke();
		context.fill();
	  }
	
	
	
	</script>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-2120330-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
</head>

<body>
	<div id="frameRate">
	</div>
</body>

</html>
